{% extends "base.html" %}
{% block title %}Регистрация{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/register.css') }}">
{% endblock %}

{% block content %}
<div class="form-container">
  <h2 class="login-header">Регистрация</h2>

  <form method="POST" novalidate>
    <!-- Имя пользователя -->
    <div class="form-group">
      <span><img src="{{ url_for('static', path='assets/bx-user.svg') }}" alt="user"></span>
      <input type="text" id="username" name="username" class="input"
             value="{{ username or '' }}"
             required
             minlength="3"
             maxlength="30"
             pattern="[a-zA-Z0-9_]+"
             title="Только буквы, цифры и подчеркивания (3-30 символов)"
             placeholder="Имя пользователя">
      <svg class="line-svg"><path d="M0 1 L100% 1"/></svg>
      {% if error and 'username' in error %}
      <span class="error">{{ error.username }}</span>
      {% endif %}
    </div>

    <!-- Email -->
    <div class="form-group">
      <span><img src="{{ url_for('static', path='assets/bx-envelope.svg') }}" alt="email"></span>
      <input type="email" id="email" name="email" class="input"
             value="{{ email or '' }}"
             required
             title="Введите корректный email адрес"
             placeholder="Email">
      <svg class="line-svg"><path d="M0 1 L100% 1"/></svg>
      {% if error and 'email' in error %}
      <span class="error">{{ error.email }}</span>
      {% endif %}
    </div>

    <!-- Телефон -->
    <div class="form-group">
      <span><img src="{{ url_for('static', path='assets/bx-phone.svg') }}" alt="phone"></span>
      <input type="tel" id="phone" name="phone" class="input"
             value="{{ phone or '' }}"
             required
             pattern="[\+\d\s\-\(\)]+"
             title="Пример: +7 999 123-45-67 или 8 999 123-45-67"
             placeholder="Телефон">
      <svg class="line-svg"><path d="M0 1 L100% 1"/></svg>
      {% if error and 'phone' in error %}
      <span class="error">{{ error.phone }}</span>
      {% endif %}
    </div>

    <!-- Пароль -->
    <div class="form-group">
      <span><img src="{{ url_for('static', path='assets/bx-lock-alt.svg') }}" alt="lock"></span>
      <input type="password" id="password" name="password" class="input"
             required
             minlength="12"
             maxlength="128"
             oninput="checkPasswordStrength(this.value)"
             placeholder="Пароль">
      <svg class="line-svg"><path d="M0 1 L100% 1"/></svg>
      {% if error and 'password' in error %}
      <span class="error">{{ error.password }}</span>
      {% endif %}

      <div class="password-strength" id="password-strength" style="display: none;">
        <div class="strength-meter">
          <div class="strength-fill" id="strength-fill"></div>
        </div>
        <div class="strength-text" id="strength-text"></div>
      </div>
    </div>

    <!-- Подтверждение пароля -->
    <div class="form-group">
      <input type="password" id="confirm" name="confirm" class="input"
             required
             placeholder="Подтвердите пароль">
      <svg class="line-svg"><path d="M0 1 L100% 1"/></svg>
      {% if error and 'confirm' in error %}
      <span class="error">{{ error.confirm }}</span>
      {% endif %}
    </div>

    <!-- Школа -->
    <div class="form-group">
      <span><img src="{{ url_for('static', path='assets/bx-school.svg') }}" alt="school"></span>
      <input type="text" id="school" name="school" class="input"
             value="{{ school or '' }}"
             required
             placeholder="Школа (номер или название)">
      <svg class="line-svg"><path d="M0 1 L100% 1"/></svg>
      {% if error and 'school' in error %}
      <span class="error">{{ error.school }}</span>
      {% endif %}
    </div>

    <!-- Класс -->
    <div class="form-group">
      <span><img src="{{ url_for('static', path='assets/bxs-book-bookmark.svg') }}" alt="grade"></span>
      <input type="text" id="grade" name="grade" class="input"
             value="{{ grade or '' }}"
             {% if not is_teacher %}required{% endif %}
             placeholder="Класс (например, 7А)">
      <svg class="line-svg"><path d="M0 1 L100% 1"/></svg>
      <small style="display: block; margin-top: 5px;">Для учеников обязательно, для учителей можно оставить пустым</small>
      {% if error and 'grade' in error %}
      <span class="error">{{ error.grade }}</span>
      {% endif %}
    </div>

    <!-- Чекбокс "Я учитель" -->
    <div class="form-group checkbox-group">
      <label>
        <input type="checkbox" name="is_teacher" value="true" {% if is_teacher %}checked{% endif %}>
        Я учитель
      </label>
    </div>

    <button type="submit" class="button-login" style="margin-top: 30px;">Зарегистрироваться</button>
  </form>

  <!-- Отображение ошибок (строковых или словарных) -->
  {% if error and error is string %}
  <ul class="error-list">
    <li>{{ error }}</li>
  </ul>
  {% endif %}

  {% if error and error is mapping and error.general %}
  <ul class="error-list">
    <li>{{ error.general }}</li>
  </ul>
  {% endif %}

  {% if success %}
  <ul class="success-list">
    <li>{{ success }}</li>
  </ul>
  {% endif %}

  <a href="/login" class="register-link">Уже есть аккаунт? Войти</a>
</div>

<!-- Подключение внешних JavaScript-файлов -->
<script src="{{ url_for('static', path='js/password_strength.js') }}"></script>
<script src="{{ url_for('static', path='js/format_phone.js') }}"></script>
<script src="{{ url_for('static', path='js/register_validation.js') }}"></script>
{% endblock %}
{% extends "base.html" %}

{% block title %}{{ student.username }}{% endblock %}

{% block extra_css %}
<style>
  .student-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  .student-header {
    background: white;
    border-radius: 10px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 30px;
  }

  .student-avatar-large {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    font-weight: 600;
  }

  .student-info h1 {
    margin: 0 0 10px;
    color: #333;
  }

  .student-info p {
    margin: 5px 0;
    color: #666;
    font-size: 16px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 30px;
  }

  .stat-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
  }

  .stat-card h3 {
    margin: 0 0 10px;
    color: #999;
    font-size: 14px;
    text-transform: uppercase;
  }

  .stat-card .value {
    font-size: 36px;
    font-weight: 600;
    color: #667eea;
  }

  .grades-section {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }

  .grades-section h2 {
    margin: 0 0 20px;
    color: #333;
  }

  .grades-filter {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .filter-select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
  }

  .grades-table {
    width: 100%;
    border-collapse: collapse;
  }

  .grades-table th {
    text-align: left;
    padding: 12px;
    background: #f9f9f9;
    color: #666;
    font-weight: 500;
  }

  .grades-table td {
    padding: 12px;
    border-bottom: 1px solid #eee;
  }

  .grades-table tr:hover {
    background: #f5f5f5;
  }

  .grade-badge {
    display: inline-block;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #667eea;
    color: white;
    text-align: center;
    line-height: 40px;
    font-weight: 600;
  }

  .grade-badge.grade-5 { background: #4caf50; }
  .grade-badge.grade-4 { background: #2196f3; }
  .grade-badge.grade-3 { background: #ff9800; }
  .grade-badge.grade-2 { background: #f44336; }

  .progress-chart {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .chart-bar {
    margin-bottom: 15px;
  }

  .chart-bar-label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    font-size: 14px;
  }

  .chart-bar-progress {
    height: 30px;
    background: #f0f0f0;
    border-radius: 5px;
    overflow: hidden;
  }

  .chart-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 10px;
    color: white;
    font-size: 12px;
  }

  .btn-add-grade {
    background: #667eea;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    margin-bottom: 20px;
  }

  .btn-add-grade:hover {
    background: #5a6fd8;
  }
</style>
{% endblock %}

{% block content %}
<div class="student-detail-container">
  <!-- –®–∞–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è —É—á–µ–Ω–∏–∫–∞ -->
  <div class="student-header">
    <div class="student-avatar-large">{{ student.username[0]|upper }}</div>
    <div class="student-info">
      <h1>{{ student.username }}</h1>
      <p>üìß {{ student.email }}</p>
      <p>üè´ {{ student.school }}</p>
      <p>üìö {{ student.grade or '–ö–ª–∞—Å—Å –Ω–µ —É–∫–∞–∑–∞–Ω' }}</p>
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="stats-grid" id="statsGrid">
    <div class="stat-card">
      <h3>–í—Å–µ–≥–æ –æ—Ü–µ–Ω–æ–∫</h3>
      <div class="value" id="totalGrades">...</div>
    </div>
    <div class="stat-card">
      <h3>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</h3>
      <div class="value" id="avgGrade">...</div>
    </div>
    <div class="stat-card">
      <h3>–û—Ç–ª–∏—á–Ω—ã—Ö –æ—Ü–µ–Ω–æ–∫</h3>
      <div class="value" id="excellentGrades">...</div>
    </div>
    <div class="stat-card">
      <h3>–í—ã–ø–æ–ª–Ω–µ–Ω–æ –î–ó</h3>
      <div class="value" id="completedHomework">...</div>
    </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏ -->
  <button class="btn-add-grade" onclick="showAddGradeModal()">
    + –î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É
  </button>

  <!-- –¢–∞–±–ª–∏—Ü–∞ –æ—Ü–µ–Ω–æ–∫ -->
  <div class="grades-section">
    <h2>üìä –í—Å–µ –æ—Ü–µ–Ω–∫–∏</h2>

    <div class="grades-filter">
      <select class="filter-select" id="subjectFilter" onchange="filterGrades()">
        <option value="">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option>
      </select>

      <input type="date" class="filter-select" id="dateFrom" onchange="filterGrades()">

      <input type="date" class="filter-select" id="dateTo" onchange="filterGrades()">
    </div>

    <table class="grades-table" id="gradesTable">
      <thead>
      <tr>
        <th>–î–∞—Ç–∞</th>
        <th>–ü—Ä–µ–¥–º–µ—Ç</th>
        <th>–û—Ü–µ–Ω–∫–∞</th>
        <th>–í–µ—Å</th>
        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
      </thead>
      <tbody id="gradesBody"></tbody>
    </table>
  </div>

  <!-- –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º -->
  <div class="progress-chart">
    <h2>üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</h2>
    <div id="subjectProgress"></div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏ -->
<div id="gradeModal" class="modal" style="display: none;">
  <div class="modal-content">
    <h2>–î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</h2>
    <form id="gradeForm">
      <input type="hidden" id="gradeId">
      <input type="hidden" name="student_id" value="{{ student.id }}">

      <div class="form-group">
        <label>–ü—Ä–µ–¥–º–µ—Ç *</label>
        <select id="gradeSubject" name="subject_id" required>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
        </select>
      </div>

      <div class="form-group">
        <label>–£—Ä–æ–∫ *</label>
        <select id="gradeLesson" name="lesson_id" required>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫</option>
        </select>
      </div>

      <div class="form-group">
        <label>–û—Ü–µ–Ω–∫–∞ *</label>
        <select id="gradeValue" name="value" required>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>

      <div class="form-group">
        <label>–í–µ—Å</label>
        <select id="gradeWeight" name="weight">
          <option value="1.0">–û–±—ã—á–Ω–∞—è (1.0)</option>
          <option value="1.5">–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è (1.5)</option>
          <option value="2.0">–≠–∫–∑–∞–º–µ–Ω (2.0)</option>
        </select>
      </div>

      <div class="form-group">
        <label>–î–∞—Ç–∞ *</label>
        <input type="date" id="gradeDate" name="date" required>
      </div>

      <div class="form-group">
        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <input type="text" id="gradeDescription" name="description" placeholder="–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –û—Ç–≤–µ—Ç —É –¥–æ—Å–∫–∏...">
      </div>

      <div class="modal-buttons">
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-secondary" onclick="closeGradeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div>

<script>
  let allGrades = [];

  document.addEventListener('DOMContentLoaded', function() {
    loadGrades();
    loadSubjects();
    loadLessons();
    loadStats();
  });

  function loadGrades() {
    fetch(`/teacher/student/{{ student.id }}/grades`)
            .then(response => response.json())
            .then(data => {
              allGrades = data;
              displayGrades(data);

              // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø—Ä–µ–¥–º–µ—Ç–æ–≤
              const subjects = [...new Set(data.map(g => g.subject))];
              const subjectFilter = document.getElementById('subjectFilter');
              subjects.forEach(subject => {
                subjectFilter.innerHTML += `<option value="${subject}">${subject}</option>`;
              });
            });
  }

  function displayGrades(grades) {
    const tbody = document.getElementById('gradesBody');
    tbody.innerHTML = '';

    grades.forEach(grade => {
      const gradeClass = `grade-badge grade-${grade.value}`;
      tbody.innerHTML += `
                <tr>
                    <td>${grade.date}</td>
                    <td>${grade.subject}</td>
                    <td><span class="${gradeClass}">${grade.value}</span></td>
                    <td>${grade.weight}</td>
                    <td>${grade.description || '-'}</td>
                    <td>
                        <button onclick="editGrade(${grade.id})" style="margin-right:5px;">‚úèÔ∏è</button>
                        <button onclick="deleteGrade(${grade.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
    });
  }

  function filterGrades() {
    const subject = document.getElementById('subjectFilter').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    let filtered = allGrades;

    if (subject) {
      filtered = filtered.filter(g => g.subject === subject);
    }
    if (dateFrom) {
      filtered = filtered.filter(g => g.date >= dateFrom);
    }
    if (dateTo) {
      filtered = filtered.filter(g => g.date <= dateTo);
    }

    displayGrades(filtered);
  }

  function loadStats() {
    fetch(`/teacher/student/{{ student.id }}/grades`)
            .then(response => response.json())
            .then(data => {
              document.getElementById('totalGrades').textContent = data.length;

              if (data.length > 0) {
                const sum = data.reduce((acc, g) => acc + g.value, 0);
                const avg = (sum / data.length).toFixed(2);
                document.getElementById('avgGrade').textContent = avg;

                const excellent = data.filter(g => g.value >= 4).length;
                document.getElementById('excellentGrades').textContent = excellent;
              } else {
                document.getElementById('avgGrade').textContent = '‚Äî';
                document.getElementById('excellentGrades').textContent = '0';
              }
            });

    fetch(`/api/stats/averages?user_id={{ student.id }}`)
            .then(response => response.json())
            .then(data => {
              const progressDiv = document.getElementById('subjectProgress');
              progressDiv.innerHTML = '';

              data.forEach(item => {
                const percentage = (item.average / 5 * 100).toFixed(0);
                progressDiv.innerHTML += `
                        <div class="chart-bar">
                            <div class="chart-bar-label">
                                <span>${item.subject_name}</span>
                                <span>${item.average.toFixed(2)}</span>
                            </div>
                            <div class="chart-bar-progress">
                                <div class="chart-bar-fill" style="width: ${percentage}%">
                                    ${item.grades_count} –æ—Ü–µ–Ω–æ–∫
                                </div>
                            </div>
                        </div>
                    `;
              });
            });
  }

  function loadSubjects() {
    fetch('/diary/api/subjects')
            .then(response => response.json())
            .then(data => {
              const select = document.getElementById('gradeSubject');
              data.forEach(subject => {
                select.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
              });
            });
  }

  function loadLessons() {
    fetch(`/diary/api/lessons?user_id={{ student.id }}`)
            .then(response => response.json())
            .then(data => {
              const select = document.getElementById('gradeLesson');
              data.forEach(lesson => {
                select.innerHTML += `
                        <option value="${lesson.id}">
                            ${lesson.date} - ${lesson.subject.name} (—É—Ä–æ–∫ ${lesson.lesson_number})
                        </option>
                    `;
              });
            });
  }

  function showAddGradeModal() {
    document.getElementById('gradeModal').style.display = 'block';
    document.getElementById('gradeForm').reset();
  }

  function closeGradeModal() {
    document.getElementById('gradeModal').style.display = 'none';
  }

  document.getElementById('gradeForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());

    fetch('/diary/api/grades', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    })
            .then(response => response.json())
            .then(data => {
              closeGradeModal();
              loadGrades();
              loadStats();
            })
            .catch(error => {
              console.error('Error:', error);
              alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏');
            });
  });

  function editGrade(gradeId) {
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏
  }

  function deleteGrade(gradeId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ü–µ–Ω–∫—É?')) return;

    fetch(`/diary/api/grades/${gradeId}`, {
      method: 'DELETE'
    })
            .then(response => response.json())
            .then(data => {
              loadGrades();
              loadStats();
            });
  }
</script>
{% endblock %}
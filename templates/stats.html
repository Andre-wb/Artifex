{% extends "base.html" %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞{% endblock %}

{% block extra_css %}
<style>
  .stats-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .subjects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .subject-card {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-top: 5px solid #3498db;
  }

  .subject-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }

  .subject-name {
    font-size: 1.3em;
    font-weight: bold;
    color: #2c3e50;
  }

  .subject-average {
    font-size: 2em;
    font-weight: bold;
    color: #27ae60;
  }

  .grades-count {
    color: #7f8c8d;
    margin-bottom: 15px;
  }

  .grades-list {
    max-height: 200px;
    overflow-y: auto;
  }

  .grade-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    border-bottom: 1px solid #f0f0f0;
  }

  .grade-value {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    background: #3498db;
  }

  .grade-date {
    color: #7f8c8d;
    font-size: 0.9em;
  }

  .grade-description {
    flex: 1;
    margin-left: 10px;
    color: #2c3e50;
  }

  .all-grades-table {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th {
    background: #f8f9fa;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #2c3e50;
    border-bottom: 2px solid #3498db;
  }

  td {
    padding: 10px 12px;
    border-bottom: 1px solid #ecf0f1;
  }

  tr:hover {
    background: #f8f9fa;
  }

  .grade-badge {
    display: inline-block;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #3498db;
    color: white;
    text-align: center;
    line-height: 30px;
    font-weight: bold;
  }

  .grade-5 { background: #27ae60; }
  .grade-4 { background: #2980b9; }
  .grade-3 { background: #f39c12; }
  .grade-2 { background: #e74c3c; }

  .filter-section {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: center;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .filter-group label {
    color: #2c3e50;
    font-weight: 500;
  }

  .filter-group select,
  .filter-group input {
    padding: 8px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
  }

  .btn-add-grade {
    background: #27ae60;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
    margin-left: auto;
  }

  .btn-add-grade:hover {
    background: #229954;
  }

  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .modal-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    color: #2c3e50;
    font-weight: 500;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1em;
  }

  .modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
    flex: 1;
  }

  .btn-primary {
    background: #3498db;
    color: white;
  }

  .btn-secondary {
    background: #95a5a6;
    color: white;
  }

  .btn-danger {
    background: #e74c3c;
    color: white;
  }
</style>
{% endblock %}

{% block content %}
<h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –æ—Ü–µ–Ω–∫–∏</h1>

<div class="stats-container">
  <div class="filter-section">
    <div class="filter-group">
      <label for="subjectFilter">–ü—Ä–µ–¥–º–µ—Ç:</label>
      <select id="subjectFilter" onchange="applyFilters()">
        <option value="">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="dateFrom">–°:</label>
      <input type="date" id="dateFrom" onchange="applyFilters()">
    </div>

    <div class="filter-group">
      <label for="dateTo">–ü–æ:</label>
      <input type="date" id="dateTo" onchange="applyFilters()">
    </div>

    <button class="btn-add-grade" onclick="showAddGradeModal()">
      + –î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É
    </button>
  </div>

  <h2>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</h2>
  <div class="subjects-grid" id="averagesContainer"></div>

  <h2>–í—Å–µ –æ—Ü–µ–Ω–∫–∏</h2>
  <div class="all-grades-table">
    <table id="gradesTable">
      <thead>
      <tr>
        <th>–î–∞—Ç–∞</th>
        <th>–ü—Ä–µ–¥–º–µ—Ç</th>
        <th>–û—Ü–µ–Ω–∫–∞</th>
        <th>–í–µ—Å</th>
        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
        <th>–£—Ä–æ–∫</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="gradeModal" class="modal">
  <div class="modal-content">
    <h2 id="gradeModalTitle">–î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</h2>
    <form id="gradeForm">
      <input type="hidden" id="gradeId" name="gradeId">
      <input type="hidden" id="gradeLessonId" name="lesson_id">

      <div class="form-group">
        <label for="gradeSubject">–ü—Ä–µ–¥–º–µ—Ç *</label>
        <select id="gradeSubject" name="subject_id" required>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
          {% for subject in subjects %}
          <option value="{{ subject.id }}">{{ subject.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="gradeValue">–û—Ü–µ–Ω–∫–∞ *</label>
        <select id="gradeValue" name="value" required>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>

      <div class="form-group">
        <label for="gradeWeight">–í–µ—Å –æ—Ü–µ–Ω–∫–∏</label>
        <select id="gradeWeight" name="weight">
          <option value="1.0">–û–±—ã—á–Ω–∞—è (1.0)</option>
          <option value="1.5">–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è (1.5)</option>
          <option value="2.0">–≠–∫–∑–∞–º–µ–Ω (2.0)</option>
        </select>
      </div>

      <div class="form-group">
        <label for="gradeDate">–î–∞—Ç–∞ *</label>
        <input type="date" id="gradeDate" name="date" required>
      </div>

      <div class="form-group">
        <label for="gradeDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <input type="text" id="gradeDescription" name="description" placeholder="–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –û—Ç–≤–µ—Ç —É –¥–æ—Å–∫–∏...">
      </div>

      <div class="modal-buttons">
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-secondary" onclick="closeGradeModal()">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-danger" id="deleteGradeBtn" style="display: none;" onclick="deleteGrade()">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<script>
  let subjects = [];
  let currentFilters = {
    subject_id: '',
    date_from: '',
    date_to: ''
  };
  let currentEditGradeId = null;

  fetch('/diary/api/subjects')
          .then(response => response.json())
          .then(data => {
            subjects = data;
            populateSubjectFilter();
            loadAverages();
            loadGrades();
          });

  function populateSubjectFilter() {
    const select = document.getElementById('subjectFilter');
    select.innerHTML = '<option value="">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option>';
    subjects.forEach(subject => {
      select.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
    });

    const gradeSubject = document.getElementById('gradeSubject');
    gradeSubject.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>';
    subjects.forEach(subject => {
      gradeSubject.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
    });
  }

  function applyFilters() {
    currentFilters = {
      subject_id: document.getElementById('subjectFilter').value,
      date_from: document.getElementById('dateFrom').value,
      date_to: document.getElementById('dateTo').value
    };
    loadGrades();
  }

  function loadAverages() {
    fetch('/diary/api/stats/averages')
            .then(response => response.json())
            .then(data => {
              const container = document.getElementById('averagesContainer');
              container.innerHTML = '';

              data.forEach(stat => {
                const gradeClass = getGradeClass(stat.average);
                container.innerHTML += `
            <div class="subject-card" style="border-top-color: ${stat.color}">
              <div class="subject-header">
                <span class="subject-name">${stat.subject_name}</span>
                <span class="subject-average ${gradeClass}">${stat.average.toFixed(2)}</span>
              </div>
              <div class="grades-count">–í—Å–µ–≥–æ –æ—Ü–µ–Ω–æ–∫: ${stat.grades_count}</div>
            </div>
          `;
              });
            });
  }

  function loadGrades() {
    let url = '/diary/api/grades?';
    if (currentFilters.subject_id) url += `&subject_id=${currentFilters.subject_id}`;
    if (currentFilters.date_from) url += `&date_from=${currentFilters.date_from}`;
    if (currentFilters.date_to) url += `&date_to=${currentFilters.date_to}`;

    fetch(url)
            .then(response => response.json())
            .then(data => {
              const tbody = document.querySelector('#gradesTable tbody');
              tbody.innerHTML = '';

              data.forEach(grade => {
                const gradeClass = `grade-${grade.value}`;
                tbody.innerHTML += `
            <tr>
              <td>${formatDate(grade.date)}</td>
              <td>${grade.subject.name}</td>
              <td><span class="grade-badge ${gradeClass}">${grade.value}</span></td>
              <td>${grade.weight}</td>
              <td>${grade.description || '-'}</td>
              <td>${grade.lesson ? grade.lesson.subject.name + ' (' + grade.lesson.date + ')' : '-'}</td>
              <td>
                <button onclick="showEditGradeModal(${grade.id})">‚úèÔ∏è</button>
                <button onclick="deleteGrade(${grade.id})">üóëÔ∏è</button>
              </td>
            </tr>
          `;
              });
            });
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('ru-RU');
  }

  function getGradeClass(average) {
    if (average >= 4.5) return 'grade-5';
    if (average >= 3.5) return 'grade-4';
    if (average >= 2.5) return 'grade-3';
    return 'grade-2';
  }

  function showAddGradeModal() {
    document.getElementById('gradeModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É';
    document.getElementById('gradeId').value = '';
    document.getElementById('gradeLessonId').value = '';
    document.getElementById('gradeForm').reset();
    document.getElementById('gradeDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('deleteGradeBtn').style.display = 'none';
    document.getElementById('gradeModal').style.display = 'flex';
  }

  function showEditGradeModal(gradeId) {
    fetch(`/diary/api/grades/${gradeId}`)
            .then(response => response.json())
            .then(grade => {
              document.getElementById('gradeModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ü–µ–Ω–∫—É';
              document.getElementById('gradeId').value = grade.id;
              document.getElementById('gradeLessonId').value = grade.lesson_id || '';
              document.getElementById('gradeSubject').value = grade.subject_id;
              document.getElementById('gradeValue').value = grade.value;
              document.getElementById('gradeWeight').value = grade.weight;
              document.getElementById('gradeDate').value = grade.date;
              document.getElementById('gradeDescription').value = grade.description || '';
              document.getElementById('deleteGradeBtn').style.display = 'block';
              document.getElementById('gradeModal').style.display = 'flex';
            });
  }

  function closeGradeModal() {
    document.getElementById('gradeModal').style.display = 'none';
  }

  document.getElementById('gradeForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const gradeId = document.getElementById('gradeId').value;
    const formData = {
      subject_id: parseInt(document.getElementById('gradeSubject').value),
      lesson_id: document.getElementById('gradeLessonId').value || null,
      value: parseInt(document.getElementById('gradeValue').value),
      weight: parseFloat(document.getElementById('gradeWeight').value),
      date: document.getElementById('gradeDate').value,
      description: document.getElementById('gradeDescription').value || null
    };

    const url = gradeId ? `/diary/api/grades/${gradeId}` : '/diary/api/grades';
    const method = gradeId ? 'PUT' : 'POST';

    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(formData)
    })
            .then(response => {
              if (response.ok) {
                closeGradeModal();
                loadGrades();
                loadAverages();
              } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏');
              }
            });
  });

  function deleteGrade() {
    const gradeId = document.getElementById('gradeId').value;
    if (!gradeId) return;

    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ—Ü–µ–Ω–∫—É?')) {
      fetch(`/diary/api/grades/${gradeId}`, {
        method: 'DELETE'
      })
              .then(response => {
                if (response.ok) {
                  closeGradeModal();
                  loadGrades();
                  loadAverages();
                } else {
                  alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏');
                }
              });
    }
  }
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}–î–Ω–µ–≤–Ω–∏–∫{% endblock %}

{% block extra_css %}
<style>
  .days-carousel {
    display: flex;
    overflow-x: auto;
    gap: 20px;
    padding: 20px 0;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
  }

  .day-card {
    flex: 0 0 350px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    padding: 20px;
    transition: transform 0.3s;
  }

  .day-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  }

  .day-card.today {
    border: 3px solid #3498db;
  }

  .day-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 15px;
    border-bottom: 2px solid #eee;
    margin-bottom: 15px;
  }

  .day-week {
    font-size: 1.2em;
    font-weight: bold;
    color: #2c3e50;
  }

  .day-date {
    color: #7f8c8d;
    font-size: 1.1em;
  }

  .lessons-list {
    min-height: 200px;
  }

  .lesson-item {
    display: grid;
    grid-template-columns: 60px 1fr 40px;
    gap: 10px;
    padding: 12px;
    border-bottom: 1px solid #f0f0f0;
    align-items: center;
    cursor: pointer;
  }

  .lesson-item:hover {
    background-color: #f5f5f5;
  }

  .lesson-time {
    font-size: 0.9em;
    color: #7f8c8d;
  }

  .lesson-name {
    font-weight: 600;
    color: #2c3e50;
  }

  .lesson-details {
    font-size: 0.85em;
    color: #95a5a6;
    display: flex;
    gap: 10px;
  }

  .lesson-grade {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
  }

  .lesson-grade.great { background: #27ae60; }
  .lesson-grade.good { background: #2980b9; }
  .lesson-grade.normal { background: #f39c12; }
  .lesson-grade.bad { background: #e74c3c; }

  .day-footer {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 2px solid #eee;
    display: flex;
    justify-content: space-between;
    color: #7f8c8d;
  }

  .carousel-nav {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 20px 0;
  }

  .nav-arrow {
    background: #3498db;
    color: white;
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 25px;
    font-size: 24px;
    cursor: pointer;
    transition: background 0.3s;
  }

  .nav-arrow:hover {
    background: #2980b9;
  }

  .add-lesson-btn {
    background: none;
    border: 2px dashed #3498db;
    color: #3498db;
    padding: 10px;
    width: 100%;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9em;
    margin-top: 10px;
    transition: all 0.3s;
  }

  .add-lesson-btn:hover {
    background: #3498db;
    color: white;
  }

  .template-btn {
    background: #9b59b6;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
    margin-left: 10px;
  }

  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .modal-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    color: #2c3e50;
    font-weight: 500;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1em;
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #3498db;
  }

  .modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
    flex: 1;
  }

  .btn-primary {
    background: #3498db;
    color: white;
  }

  .btn-secondary {
    background: #95a5a6;
    color: white;
  }

  .btn-danger {
    background: #e74c3c;
    color: white;
  }

  .header-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
</style>
{% endblock %}

{% block content %}
<div class="header-actions">
  <h1>üìö –î–Ω–µ–≤–Ω–∏–∫</h1>
  <button class="template-btn" onclick="window.location.href='/templates'">
    ‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–º
  </button>
</div>

<div class="current-date-info">
  <span class="current-date">–°–µ–≥–æ–¥–Ω—è: {{ today.strftime('%d %B %Y') }}</span>
</div>

<div class="days-carousel">
  {% for day in days %}
  <div class="day-card {% if day.date == today %}today{% endif %}" data-date="{{ day.date.isoformat() }}">
    <div class="day-header">
      <span class="day-week">{{ weekdays[day.date.weekday()] }}</span>
      <span class="day-date">{{ day.date.strftime('%d.%m') }}</span>
    </div>

    <div class="lessons-list" id="lessons-{{ day.date.isoformat() }}">
      {% for lesson in day.lessons %}
      <div class="lesson-item" data-lesson-id="{{ lesson.id }}" ondblclick="showEditLessonModal({{ lesson.id }})">
        <div class="lesson-time">{{ lesson.start_time or '--:--' }}</div>
        <div class="lesson-info">
          <div class="lesson-name">{{ lesson.subject.name }}</div>
          <div class="lesson-details">
            <span class="lesson-room">{{ lesson.room or '–∫–∞–±. --' }}</span>
            <span class="lesson-teacher">{{ lesson.subject.teacher_name or '' }}</span>
          </div>
          {% if lesson.homework %}
          <div class="lesson-homework">üìö {{ lesson.homework[:30] }}{% if lesson.homework|length > 30 %}...{% endif %}</div>
          {% endif %}
        </div>
        <div class="lesson-grade
          {% if lesson.grades %}
            {% if lesson.grades[0].value >= 4 %}great
            {% elif lesson.grades[0].value == 3 %}normal
            {% else %}bad{% endif %}
          {% endif %}">
          {% if lesson.grades %}
          {{ lesson.grades[0].value }}
          {% endif %}
        </div>
      </div>
      {% endfor %}

      <button class="add-lesson-btn" onclick="showAddLessonModal('{{ day.date.isoformat() }}')">
        + –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫
      </button>
    </div>

    <div class="day-footer">
      <span class="lessons-edit">–£—Ä–æ–∫–æ–≤: {{ day.lessons|length }}</span>
      <span class="lesson-count">
        {% set ns = namespace(total=0) %}
        {% for lesson in day.lessons %}
          {% if lesson.grades %}
            {% set ns.total = ns.total + lesson.grades|length %}
          {% endif %}
        {% endfor %}
        –û—Ü–µ–Ω–æ–∫: {{ ns.total }}
      </span>
    </div>
  </div>
  {% endfor %}
</div>

<div class="carousel-nav">
  <button class="nav-arrow prev" onclick="scrollCarousel(-400)">‚Üê</button>
  <button class="nav-arrow next" onclick="scrollCarousel(400)">‚Üí</button>
  <button class="nav-arrow" onclick="document.querySelector('.today').scrollIntoView({behavior: 'smooth', block: 'center'})">
    üìç
  </button>
</div>

<div id="lessonModal" class="modal">
  <div class="modal-content">
    <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫</h2>
    <form id="lessonForm">
      <input type="hidden" id="lessonId" name="lessonId">
      <input type="hidden" id="lessonDate" name="lessonDate">

      <div class="form-group">
        <label for="subject">–ü—Ä–µ–¥–º–µ—Ç *</label>
        <select id="subject" name="subject_id" required>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
          {% for subject in subjects %}
          <option value="{{ subject.id }}">{{ subject.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="lessonNumber">–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞ *</label>
        <input type="number" id="lessonNumber" name="lesson_number" min="1" max="8" required>
      </div>

      <div class="form-group">
        <label for="startTime">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>
        <input type="time" id="startTime" name="start_time">
      </div>

      <div class="form-group">
        <label for="endTime">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
        <input type="time" id="endTime" name="end_time">
      </div>

      <div class="form-group">
        <label for="room">–ö–∞–±–∏–Ω–µ—Ç</label>
        <input type="text" id="room" name="room">
      </div>

      <div class="form-group">
        <label for="homework">–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</label>
        <textarea id="homework" name="homework" rows="3"></textarea>
      </div>

      <div class="form-group">
        <label for="notes">–ó–∞–º–µ—Ç–∫–∏</label>
        <textarea id="notes" name="notes" rows="2"></textarea>
      </div>

      <div class="modal-buttons">
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-danger" id="deleteLessonBtn" style="display: none;" onclick="deleteLesson()">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<div id="gradeModal" class="modal">
  <div class="modal-content">
    <h2 id="gradeModalTitle">–î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</h2>
    <form id="gradeForm">
      <input type="hidden" id="gradeId" name="gradeId">
      <input type="hidden" id="gradeLessonId" name="lesson_id">

      <div class="form-group">
        <label for="gradeSubject">–ü—Ä–µ–¥–º–µ—Ç *</label>
        <select id="gradeSubject" name="subject_id" required>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
          {% for subject in subjects %}
          <option value="{{ subject.id }}">{{ subject.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="gradeValue">–û—Ü–µ–Ω–∫–∞ *</label>
        <select id="gradeValue" name="value" required>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>

      <div class="form-group">
        <label for="gradeWeight">–í–µ—Å –æ—Ü–µ–Ω–∫–∏</label>
        <select id="gradeWeight" name="weight">
          <option value="1.0">–û–±—ã—á–Ω–∞—è (1.0)</option>
          <option value="1.5">–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è (1.5)</option>
          <option value="2.0">–≠–∫–∑–∞–º–µ–Ω (2.0)</option>
        </select>
      </div>

      <div class="form-group">
        <label for="gradeDate">–î–∞—Ç–∞ *</label>
        <input type="date" id="gradeDate" name="date" required>
      </div>

      <div class="form-group">
        <label for="gradeDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <input type="text" id="gradeDescription" name="description" placeholder="–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –û—Ç–≤–µ—Ç —É –¥–æ—Å–∫–∏...">
      </div>

      <div class="modal-buttons">
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-secondary" onclick="closeGradeModal()">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-danger" id="deleteGradeBtn" style="display: none;" onclick="deleteGrade()">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<script>
  let currentEditLessonId = null;
  let currentEditGradeId = null;

  function scrollCarousel(offset) {
    document.querySelector('.days-carousel').scrollBy({left: offset, behavior: 'smooth'});
  }

  function showAddLessonModal(date) {
    document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫';
    document.getElementById('lessonId').value = '';
    document.getElementById('lessonDate').value = date;
    document.getElementById('lessonForm').reset();
    document.getElementById('deleteLessonBtn').style.display = 'none';
    document.getElementById('lessonModal').style.display = 'flex';
  }

  function showEditLessonModal(lessonId) {
    fetch(`/diary/api/lessons/${lessonId}`)
            .then(response => response.json())
            .then(lesson => {
              document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–∫';
              document.getElementById('lessonId').value = lesson.id;
              document.getElementById('lessonDate').value = lesson.date;
              document.getElementById('subject').value = lesson.subject_id;
              document.getElementById('lessonNumber').value = lesson.lesson_number;
              document.getElementById('startTime').value = lesson.start_time || '';
              document.getElementById('endTime').value = lesson.end_time || '';
              document.getElementById('room').value = lesson.room || '';
              document.getElementById('homework').value = lesson.homework || '';
              document.getElementById('notes').value = lesson.notes || '';
              document.getElementById('deleteLessonBtn').style.display = 'block';
              document.getElementById('lessonModal').style.display = 'flex';
            });
  }

  function closeModal() {
    document.getElementById('lessonModal').style.display = 'none';
  }

  document.getElementById('lessonForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const lessonId = document.getElementById('lessonId').value;
    const formData = {
      subject_id: parseInt(document.getElementById('subject').value),
      date: document.getElementById('lessonDate').value,
      lesson_number: parseInt(document.getElementById('lessonNumber').value),
      start_time: document.getElementById('startTime').value || null,
      end_time: document.getElementById('endTime').value || null,
      room: document.getElementById('room').value || null,
      homework: document.getElementById('homework').value || null,
      notes: document.getElementById('notes').value || null
    };

    const url = lessonId ? `/diary/api/lessons/${lessonId}` : '/diary/api/lessons';
    const method = lessonId ? 'PUT' : 'POST';

    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(formData)
    })
            .then(response => {
              if (response.ok) {
                closeModal();
                location.reload();
              } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—Ä–æ–∫–∞');
              }
            });
  });

  function deleteLesson() {
    const lessonId = document.getElementById('lessonId').value;
    if (!lessonId) return;

    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —É—Ä–æ–∫?')) {
      fetch(`/diary/api/lessons/${lessonId}`, {
        method: 'DELETE'
      })
              .then(response => {
                if (response.ok) {
                  closeModal();
                  location.reload();
                } else {
                  alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—Ä–æ–∫–∞');
                }
              });
    }
  }

  function showAddGradeModal(lessonId = null) {
    document.getElementById('gradeModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É';
    document.getElementById('gradeId').value = '';
    document.getElementById('gradeLessonId').value = lessonId || '';
    document.getElementById('gradeForm').reset();
    document.getElementById('gradeDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('deleteGradeBtn').style.display = 'none';
    document.getElementById('gradeModal').style.display = 'flex';
  }

  function showEditGradeModal(gradeId) {
    fetch(`/diary/api/grades/${gradeId}`)
            .then(response => response.json())
            .then(grade => {
              document.getElementById('gradeModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ü–µ–Ω–∫—É';
              document.getElementById('gradeId').value = grade.id;
              document.getElementById('gradeLessonId').value = grade.lesson_id || '';
              document.getElementById('gradeSubject').value = grade.subject_id;
              document.getElementById('gradeValue').value = grade.value;
              document.getElementById('gradeWeight').value = grade.weight;
              document.getElementById('gradeDate').value = grade.date;
              document.getElementById('gradeDescription').value = grade.description || '';
              document.getElementById('deleteGradeBtn').style.display = 'block';
              document.getElementById('gradeModal').style.display = 'flex';
            });
  }

  function closeGradeModal() {
    document.getElementById('gradeModal').style.display = 'none';
  }

  document.getElementById('gradeForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const gradeId = document.getElementById('gradeId').value;
    const formData = {
      subject_id: parseInt(document.getElementById('gradeSubject').value),
      lesson_id: document.getElementById('gradeLessonId').value || null,
      value: parseInt(document.getElementById('gradeValue').value),
      weight: parseFloat(document.getElementById('gradeWeight').value),
      date: document.getElementById('gradeDate').value,
      description: document.getElementById('gradeDescription').value || null
    };

    const url = gradeId ? `/diary/api/grades/${gradeId}` : '/diary/api/grades';
    const method = gradeId ? 'PUT' : 'POST';

    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(formData)
    })
            .then(response => {
              if (response.ok) {
                closeGradeModal();
                location.reload();
              } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏');
              }
            });
  });

  function deleteGrade() {
    const gradeId = document.getElementById('gradeId').value;
    if (!gradeId) return;

    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ—Ü–µ–Ω–∫—É?')) {
      fetch(`/diary/api/grades/${gradeId}`, {
        method: 'DELETE'
      })
              .then(response => {
                if (response.ok) {
                  closeGradeModal();
                  location.reload();
                } else {
                  alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏');
                }
              });
    }
  }
</script>
{% endblock %}
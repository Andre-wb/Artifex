{% extends "base.html" %}

{% block title %}–î–Ω–µ–≤–Ω–∏–∫{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/diary.css') }}">
{% endblock %}

{% block content %}
<div class="diary-header">
  <div class="current-date-info">
    <span class="current-date">–°–µ–≥–æ–¥–Ω—è: {{ today.strftime('%d %B %Y') }}</span>
  </div>
  <div class="diary-actions">
    <button class="btn btn-primary" onclick="openSubjectManager()">üìö –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏</button>
  </div>
</div>

<div class="days-carousel">
  {% for day in days %}
  <div class="day-card {% if day.date == today %}today{% endif %}" data-date="{{ day.date.isoformat() }}">
    <div class="day-header">
      <span class="day-week">{{ weekdays[day.date.weekday()] }}</span>
      <span class="day-date">{{ day.date.strftime('%d.%m') }}</span>
    </div>

    <div class="lessons-list" id="lessons-{{ day.date.isoformat() }}">
      {% for lesson in day.lessons %}
      <div class="lesson-item" data-lesson-id="{{ lesson.id }}" ondblclick="showEditLessonModal({{ lesson.id }})">
        <div class="lesson-time">{{ lesson.start_time or '--:--' }}</div>
        <div class="lesson-info">
          <div class="lesson-name">{{ lesson.subject.name }}</div>
          <div class="lesson-details">
            <span class="lesson-room">{{ lesson.room or '–∫–∞–±. --' }}</span>
            <span class="lesson-teacher">{{ lesson.subject.teacher_name or '' }}</span>
          </div>
          {% if lesson.homework %}
          <div class="lesson-homework"><img src="{{ url_for('static', path='assets/bx-book-bookmark.svg') }}"> {{ lesson.homework[:30] }}{% if lesson.homework|length > 30 %}...{% endif %}</div>
          {% endif %}
        </div>
        <div class="lesson-grade {% if lesson.grades %}{% if lesson.grades[0].value >= 4 %}great{% elif lesson.grades[0].value == 3 %}normal{% else %}bad{% endif %}{% endif %}">
          {% if lesson.grades %}{{ lesson.grades[0].value }}{% endif %}
        </div>
        <!-- –ö–Ω–æ–ø–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏ –∫ —É—Ä–æ–∫—É -->
        <button class="quick-add-grade" onclick="showAddGradeModal({{ lesson.id }})" title="–î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É">‚ûï</button>
      </div>
      {% endfor %}

      <button class="add-lesson-btn" onclick="showAddLessonModal('{{ day.date.isoformat() }}')">
        + –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫
      </button>
    </div>

    <div class="day-footer">
      <span class="lessons-edit">–£—Ä–æ–∫–æ–≤: {{ day.lessons|length }}</span>
      <span class="lesson-count">
        {% set ns = namespace(total=0) %}
        {% for lesson in day.lessons %}
          {% if lesson.grades %}
            {% set ns.total = ns.total + lesson.grades|length %}
          {% endif %}
        {% endfor %}
        –û—Ü–µ–Ω–æ–∫: {{ ns.total }}
      </span>
    </div>
  </div>
  {% endfor %}
</div>

<div class="carousel-nav">
  <button class="nav-arrow prev" onclick="scrollCarousel(-400)">‚Üê</button>
  <button class="nav-arrow next" onclick="scrollCarousel(400)">‚Üí</button>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É—Ä–æ–∫–∞ -->
<div id="lessonModal" class="modal">
  <div class="modal-content">
    <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫</h2>
    <form id="lessonForm">
      <input type="hidden" id="lessonId" name="lessonId">
      <input type="hidden" id="lessonDate" name="lessonDate">

      <div class="form-group">
        <label for="subject">–ü—Ä–µ–¥–º–µ—Ç *</label>
        <select id="subject" name="subject_id" required>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
          {% for subject in subjects %}
          <option value="{{ subject.id }}">{{ subject.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="lessonNumber">–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞ *</label>
        <input type="number" id="lessonNumber" name="lesson_number" min="1" max="8" required>
      </div>

      <div class="form-group">
        <label for="startTime">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>
        <input type="time" id="startTime" name="start_time">
      </div>

      <div class="form-group">
        <label for="endTime">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
        <input type="time" id="endTime" name="end_time">
      </div>

      <div class="form-group">
        <label for="room">–ö–∞–±–∏–Ω–µ—Ç</label>
        <input type="text" id="room" name="room">
      </div>

      <div class="form-group">
        <label for="homework">–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</label>
        <textarea id="homework" name="homework" rows="3" style="resize: none"></textarea>
      </div>

      <div class="form-group">
        <label for="notes">–ó–∞–º–µ—Ç–∫–∏</label>
        <textarea id="notes" name="notes" rows="2" style="resize: none"></textarea>
      </div>

      <div class="modal-buttons">
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-danger" id="deleteLessonBtn" style="display: none;" onclick="deleteLesson()">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ -->
<div id="gradeModal" class="modal">
  <div class="modal-content">
    <h2 id="gradeModalTitle">–î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</h2>
    <form id="gradeForm">
      <input type="hidden" id="gradeId" name="gradeId">
      <input type="hidden" id="gradeLessonId" name="lesson_id">

      <div class="form-group">
        <label for="gradeSubject">–ü—Ä–µ–¥–º–µ—Ç *</label>
        <select id="gradeSubject" name="subject_id" required>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
          {% for subject in subjects %}
          <option value="{{ subject.id }}">{{ subject.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="gradeValue">–û—Ü–µ–Ω–∫–∞ *</label>
        <select id="gradeValue" name="value" required>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>

      <div class="form-group">
        <label for="gradeWeight">–í–µ—Å –æ—Ü–µ–Ω–∫–∏</label>
        <select id="gradeWeight" name="weight">
          <option value="1.0">–û–±—ã—á–Ω–∞—è (1.0)</option>
          <option value="1.5">–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è (1.5)</option>
          <option value="2.0">–≠–∫–∑–∞–º–µ–Ω (2.0)</option>
        </select>
      </div>

      <div class="form-group">
        <label for="gradeDate">–î–∞—Ç–∞ *</label>
        <input type="date" id="gradeDate" name="date" required>
      </div>

      <div class="form-group">
        <label for="gradeDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <input type="text" id="gradeDescription" name="description" placeholder="–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –û—Ç–≤–µ—Ç —É –¥–æ—Å–∫–∏...">
      </div>

      <div class="modal-buttons">
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-secondary" onclick="closeGradeModal()">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-danger" id="deleteGradeBtn" style="display: none;" onclick="deleteGrade()">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏ -->
<div id="subjectManagerModal" class="modal">
  <div class="modal-content modal-lg">
    <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏</h2>
    <div class="subject-list" id="subjectList">
      <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ -->
      <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
    <div class="modal-buttons">
      <button class="btn btn-primary" onclick="showAddSubjectForm()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
      <button class="btn btn-secondary" onclick="closeSubjectManager()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞ (–≤—Å–ø–ª—ã–≤–∞–µ—Ç –ø–æ–≤–µ—Ä—Ö manager) -->
<div id="subjectFormModal" class="modal" style="z-index: 2000;">
  <div class="modal-content">
    <h2 id="subjectFormTitle">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</h2>
    <form id="subjectForm">
      <input type="hidden" id="subjectId" name="subjectId">

      <div class="form-group">
        <label for="subjectName">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ *</label>
        <input type="text" id="subjectName" name="name" required maxlength="50">
      </div>

      <div class="form-group">
        <label for="subjectDescription">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <textarea id="subjectDescription" name="description" rows="2" style="resize: none"></textarea>
      </div>

      <div class="modal-buttons">
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-secondary" onclick="closeSubjectForm()">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-danger" id="deleteSubjectBtn" style="display: none;" onclick="deleteSubjectFromForm()">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞ -->
<div id="confirmSubjectDeleteModal" class="modal" style="z-index: 2100;">
  <div class="modal-content" style="max-width: 400px;">
    <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
    <p id="confirmSubjectMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç?</p>
    <div class="modal-buttons">
      <button class="btn btn-danger" onclick="confirmDeleteSubject()">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="btn btn-secondary" onclick="closeConfirmDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<script src="{{ url_for('static', path='js/diary.js') }}"></script>

<!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π JavaScript –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏ -->
<script>
  // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
  let currentSubjects = [];
  let subjectToDelete = null;

  // –û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–µ–¥–º–µ—Ç–æ–≤
  function openSubjectManager() {
    document.getElementById('subjectManagerModal').style.display = 'flex';
    loadSubjectsList();
  }

  // –ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–µ–¥–º–µ—Ç–æ–≤
  function closeSubjectManager() {
    document.getElementById('subjectManagerModal').style.display = 'none';
  }

  // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
  function loadSubjectsList() {
    const container = document.getElementById('subjectList');
    container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';

    fetch('/diary/api/subjects')
            .then(response => {
              if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
              return response.json();
            })
            .then(subjects => {
              currentSubjects = subjects;
              if (subjects.length === 0) {
                container.innerHTML = '<p class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</p>';
                return;
              }

              let html = '<div class="subjects-grid">';
              subjects.forEach(subj => {
                html += `
                    <div class="subject-card" data-id="${subj.id}">
                        <div class="subject-info">
                            <strong>${escapeHtml(subj.name)}</strong>
                            ${subj.description ? `<small>${escapeHtml(subj.description)}</small>` : ''}
                        </div>
                        <div class="subject-actions">
                            <button class="btn-icon" onclick="editSubject(${subj.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                            <button class="btn-icon" onclick="promptDeleteSubject(${subj.id}, '${escapeHtml(subj.name)}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
              });
              html += '</div>';
              container.innerHTML = html;
            })
            .catch(error => {
              console.error(error);
              container.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</p>';
            });
  }

  // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è XSS
  function escapeHtml(unsafe) {
    return unsafe.replace(/[&<>"]/g, function(m) {
      if (m === '&') return '&amp;';
      if (m === '<') return '&lt;';
      if (m === '>') return '&gt;';
      if (m === '"') return '&quot;';
      return m;
    });
  }

  // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞
  function showAddSubjectForm() {
    document.getElementById('subjectFormTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç';
    document.getElementById('subjectId').value = '';
    document.getElementById('subjectName').value = '';
    document.getElementById('subjectDescription').value = '';
    document.getElementById('deleteSubjectBtn').style.display = 'none';
    document.getElementById('subjectFormModal').style.display = 'flex';
  }

  // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
  function editSubject(subjectId) {
    const subject = currentSubjects.find(s => s.id === subjectId);
    if (!subject) return;

    document.getElementById('subjectFormTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç';
    document.getElementById('subjectId').value = subject.id;
    document.getElementById('subjectName').value = subject.name;
    document.getElementById('subjectDescription').value = subject.description || '';
    document.getElementById('deleteSubjectBtn').style.display = 'block';
    document.getElementById('subjectFormModal').style.display = 'flex';
  }

  // –ó–∞–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –ø—Ä–µ–¥–º–µ—Ç–∞
  function closeSubjectForm() {
    document.getElementById('subjectFormModal').style.display = 'none';
  }

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã)
  document.addEventListener('DOMContentLoaded', function() {
    const subjectForm = document.getElementById('subjectForm');
    if (subjectForm) {
      subjectForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const subjectId = document.getElementById('subjectId').value;
        const formData = {
          name: document.getElementById('subjectName').value.trim(),
          description: document.getElementById('subjectDescription').value.trim() || null
        };

        if (!formData.name) {
          alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞');
          return;
        }

        const url = subjectId ? `/diary/api/subjects/${subjectId}` : '/diary/api/subjects';
        const method = subjectId ? 'PUT' : 'POST';

        fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        })
                .then(response => {
                  if (!response.ok) {
                    return response.json().then(data => {
                      throw new Error(data.detail || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                    });
                  }
                  return response.json();
                })
                .then(() => {
                  closeSubjectForm();
                  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –≤ –º–µ–Ω–µ–¥–∂–µ—Ä–µ
                  loadSubjectsList();
                  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç—ã –≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö (–æ–Ω–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑—è—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏, –Ω–æ –º–æ–∂–Ω–æ –∏ –æ–±–Ω–æ–≤–∏—Ç—å)
                  // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã —Å–µ–ª–µ–∫—Ç—ã —Ç–æ—á–Ω–æ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å
                  location.reload(); // –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –±–æ–ª–µ–µ —É–º–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –Ω–æ –¥–ª—è –¥–µ–º–æ —Å–æ–π–¥—ë—Ç
                })
                .catch(error => {
                  alert(error.message);
                });
      });
    }
  });

  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞
  function promptDeleteSubject(subjectId, subjectName) {
    subjectToDelete = subjectId;
    document.getElementById('confirmSubjectMessage').textContent = `–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç ¬´${subjectName}¬ª? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`;
    document.getElementById('confirmSubjectDeleteModal').style.display = 'flex';
  }

  function closeConfirmDeleteModal() {
    document.getElementById('confirmSubjectDeleteModal').style.display = 'none';
    subjectToDelete = null;
  }

  function confirmDeleteSubject() {
    if (!subjectToDelete) return;

    fetch(`/diary/api/subjects/${subjectToDelete}`, {
      method: 'DELETE'
    })
            .then(response => {
              if (!response.ok) {
                return response.json().then(data => {
                  throw new Error(data.detail || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                });
              }
              return response.json();
            })
            .then(() => {
              closeConfirmDeleteModal();
              loadSubjectsList();
              location.reload(); // –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ–ª–µ–∫—Ç–æ–≤
            })
            .catch(error => {
              alert(error.message);
              closeConfirmDeleteModal();
            });
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å")
  function deleteSubjectFromForm() {
    const subjectId = document.getElementById('subjectId').value;
    if (subjectId) {
      promptDeleteSubject(subjectId, document.getElementById('subjectName').value);
      closeSubjectForm();
    }
  }

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
  window.onclick = function(event) {
    const modals = ['lessonModal', 'gradeModal', 'subjectManagerModal', 'subjectFormModal', 'confirmSubjectDeleteModal'];
    modals.forEach(id => {
      const modal = document.getElementById(id);
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    });
  }

  // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  const style = document.createElement('style');
  style.textContent = `
    .diary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .diary-actions {
        display: flex;
        gap: 0.5rem;
    }
    .lesson-item {
        position: relative;
    }
    .quick-add-grade {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        line-height: 1;
    }
    .lesson-item:hover .quick-add-grade {
        opacity: 1;
    }
    .modal.modal-lg .modal-content {
        max-width: 600px;
    }
    .subjects-grid {
        display: grid;
        gap: 0.75rem;
        max-height: 400px;
        overflow-y: auto;
        padding: 0.5rem;
    }
    .subject-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: var(--bg-secondary);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }
    .subject-info {
        display: flex;
        flex-direction: column;
    }
    .subject-info small {
        color: var(--text-secondary);
        font-size: 0.85rem;
    }
    .subject-actions {
        display: flex;
        gap: 0.5rem;
    }
    .btn-icon {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: background 0.2s;
    }
    .btn-icon:hover {
        background: var(--bg-hover);
    }
    .empty-state {
        text-align: center;
        color: var(--text-secondary);
        padding: 2rem;
    }
    .error {
        color: var(--error-color);
        text-align: center;
    }
`;
  document.head.appendChild(style);
</script>
{% endblock %}
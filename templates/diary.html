{% extends "base.html" %}

{% block title %}–î–Ω–µ–≤–Ω–∏–∫{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/diary.css') }}">
{% endblock %}

{% block content %}
<div class="diary-header">
  <div class="current-date-info">
    <span class="current-date">–°–µ–≥–æ–¥–Ω—è: {{ today.strftime('%d %B %Y') }}</span>
  </div>

  <button class="generate-btn" onclick="generateLessonsFromTemplate()">
    üîÑ –°–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫–∏ –Ω–∞ 2 –Ω–µ–¥–µ–ª–∏ –≤–ø–µ—Ä–µ–¥ –∏–∑ —à–∞–±–ª–æ–Ω–∞
  </button>
</div>

<div class="current-date-info">
  <span class="current-date">–°–µ–≥–æ–¥–Ω—è: {{ today.strftime('%d %B %Y') }}</span>
</div>

<div class="days-carousel">
  {% for day in days %}
  <div class="day-card {% if day.date == today %}today{% endif %}" data-date="{{ day.date.isoformat() }}">
    <div class="day-header">
      <span class="day-week">{{ weekdays[day.date.weekday()] }}</span>
      <span class="day-date">{{ day.date.strftime('%d.%m') }}</span>
    </div>

    <div class="lessons-list" id="lessons-{{ day.date.isoformat() }}">
      {% for lesson in day.lessons %}
      <div class="lesson-item" data-lesson-id="{{ lesson.id }}" ondblclick="showEditLessonModal({{ lesson.id }})">
        <div class="lesson-time">{{ lesson.start_time or '--:--' }}</div>
        <div class="lesson-info">
          <div class="lesson-name">{{ lesson.subject.name }}</div>
          <div class="lesson-details">
            <span class="lesson-room">{{ lesson.room or '–∫–∞–±. --' }}</span>
            <span class="lesson-teacher">{{ lesson.subject.teacher_name or '' }}</span>
          </div>
          {% if lesson.homework %}
          <div class="lesson-homework">üìö {{ lesson.homework[:30] }}{% if lesson.homework|length > 30 %}...{% endif %}</div>
          {% endif %}
        </div>
        <div class="lesson-grade
          {% if lesson.grades %}
            {% if lesson.grades[0].value >= 4 %}great
            {% elif lesson.grades[0].value == 3 %}normal
            {% else %}bad{% endif %}
          {% endif %}">
          {% if lesson.grades %}
          {{ lesson.grades[0].value }}
          {% endif %}
        </div>
      </div>
      {% endfor %}

      <button class="add-lesson-btn" onclick="showAddLessonModal('{{ day.date.isoformat() }}')">
        + –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫
      </button>
    </div>

    <div class="day-footer">
      <span class="lessons-edit">–£—Ä–æ–∫–æ–≤: {{ day.lessons|length }}</span>
      <span class="lesson-count">
        {% set ns = namespace(total=0) %}
        {% for lesson in day.lessons %}
          {% if lesson.grades %}
            {% set ns.total = ns.total + lesson.grades|length %}
          {% endif %}
        {% endfor %}
        –û—Ü–µ–Ω–æ–∫: {{ ns.total }}
      </span>
    </div>
  </div>
  {% endfor %}
</div>

<div class="carousel-nav">
  <button class="nav-arrow prev" onclick="scrollCarousel(-400)">‚Üê</button>
  <button class="nav-arrow next" onclick="scrollCarousel(400)">‚Üí</button>
  <button class="nav-arrow" onclick="document.querySelector('.today').scrollIntoView({behavior: 'smooth', block: 'center'})">
    üìç
  </button>
</div>

<div id="lessonModal" class="modal">
  <div class="modal-content">
    <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫</h2>
    <form id="lessonForm">
      <input type="hidden" id="lessonId" name="lessonId">
      <input type="hidden" id="lessonDate" name="lessonDate">

      <div class="form-group">
        <label for="subject">–ü—Ä–µ–¥–º–µ—Ç *</label>
        <select id="subject" name="subject_id" required>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
          {% for subject in subjects %}
          <option value="{{ subject.id }}">{{ subject.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="lessonNumber">–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞ *</label>
        <input type="number" id="lessonNumber" name="lesson_number" min="1" max="8" required>
      </div>

      <div class="form-group">
        <label for="startTime">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>
        <input type="time" id="startTime" name="start_time">
      </div>

      <div class="form-group">
        <label for="endTime">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
        <input type="time" id="endTime" name="end_time">
      </div>

      <div class="form-group">
        <label for="room">–ö–∞–±–∏–Ω–µ—Ç</label>
        <input type="text" id="room" name="room">
      </div>

      <div class="form-group">
        <label for="homework">–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</label>
        <textarea id="homework" name="homework" rows="3" style="resize: none"></textarea>
      </div>

      <div class="form-group">
        <label for="notes">–ó–∞–º–µ—Ç–∫–∏</label>
        <textarea id="notes" name="notes" rows="2" style="resize: none"></textarea>
      </div>

      <div class="modal-buttons">
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-danger" id="deleteLessonBtn" style="display: none;" onclick="deleteLesson()">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<div id="gradeModal" class="modal">
  <div class="modal-content">
    <h2 id="gradeModalTitle">–î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</h2>
    <form id="gradeForm">
      <input type="hidden" id="gradeId" name="gradeId">
      <input type="hidden" id="gradeLessonId" name="lesson_id">

      <div class="form-group">
        <label for="gradeSubject">–ü—Ä–µ–¥–º–µ—Ç *</label>
        <select id="gradeSubject" name="subject_id" required>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
          {% for subject in subjects %}
          <option value="{{ subject.id }}">{{ subject.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="gradeValue">–û—Ü–µ–Ω–∫–∞ *</label>
        <select id="gradeValue" name="value" required>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>

      <div class="form-group">
        <label for="gradeWeight">–í–µ—Å –æ—Ü–µ–Ω–∫–∏</label>
        <select id="gradeWeight" name="weight">
          <option value="1.0">–û–±—ã—á–Ω–∞—è (1.0)</option>
          <option value="1.5">–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è (1.5)</option>
          <option value="2.0">–≠–∫–∑–∞–º–µ–Ω (2.0)</option>
        </select>
      </div>

      <div class="form-group">
        <label for="gradeDate">–î–∞—Ç–∞ *</label>
        <input type="date" id="gradeDate" name="date" required>
      </div>

      <div class="form-group">
        <label for="gradeDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <input type="text" id="gradeDescription" name="description" placeholder="–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –û—Ç–≤–µ—Ç —É –¥–æ—Å–∫–∏...">
      </div>

      <div class="modal-buttons">
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-secondary" onclick="closeGradeModal()">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-danger" id="deleteGradeBtn" style="display: none;" onclick="deleteGrade()">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<script src="{{ url_for('static', path='js/diary.js') }}"></script>
{% endblock %}
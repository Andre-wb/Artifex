{% extends "base.html" %}

{% block title %}Шаблон расписания{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/templates.css') }}">
{% endblock %}

{% block content %}
<h1><img src="{{ url_for('static', path='assets/bx-calendar-week.svg') }}" class="invert"> Шаблон расписания</h1>

<div class="templates-container">
    <button class="generate-btn" onclick="generateLessons()">
        <img src="{{ url_for('static', path='assets/bx-repeat.svg') }}" class="invert"> Создать уроки на 2 недели вперед из шаблона
    </button>

    {% for day_index in range(7) %}
    <div class="day-section" data-day="{{ day_index }}">
        <div class="day-title">{{ weekdays[day_index] }}</div>

        <div class="templates-list" id="templates-{{ day_index }}">
            {% for template in templates if template.day_of_week == day_index %}
            <div class="template-lesson" data-template-id="{{ template.id }}">
                <div class="lesson-number">{{ template.lesson_number }}.</div>
                <div class="lesson-subject">{{ template.subject.name }}</div>
                <div class="lesson-time">
                    {% if template.start_time %}
                    {{ template.start_time }}{% if template.end_time %} - {{ template.end_time }}{% endif %}
                    {% else %}
                    Время не указано
                    {% endif %}
                </div>
                <div class="lesson-actions">
                    <button onclick="editTemplate({{ template.id }})" class="edit-btn" title="Редактировать"><img src="{{ url_for('static', path='assets/bx-pencil.svg') }}" class="invert"></button>
                    <button onclick="deleteTemplate({{ template.id }})" class="delete-btn" title="Удалить"><img src="{{ url_for('static', path='assets/bx-trash.svg') }}" class="invert"></button>
                </div>
            </div>
            {% endfor %}
        </div>

        <button class="add-lesson-btn" onclick="showAddTemplateModal({{ day_index }})">
            + Добавить урок в {{ weekdays[day_index]|lower }}
        </button>
    </div>
    {% endfor %}
</div>

<!-- Модальное окно для добавления/редактирования урока -->
<div id="templateModal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle">Добавить урок в шаблон</h2>
        <form id="templateForm">
            <input type="hidden" id="templateId" name="templateId">
            <input type="hidden" id="templateDay" name="day_of_week">

            <!-- Поле выбора предмета с кнопкой добавления -->
            <div class="form-group subject-group">
                <label for="templateSubject">Предмет *</label>
                <div class="subject-select-wrapper">
                    <select id="templateSubject" name="subject_id" required>
                        <option value="">Выберите предмет</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="add-subject-btn" onclick="showNewSubjectModal()" title="Добавить новый предмет">
                        <span class="plus-icon">+</span>
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label for="templateLessonNumber">Номер урока *</label>
                <input type="number" id="templateLessonNumber" name="lesson_number" min="1" max="8" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="templateStartTime">Время начала</label>
                    <input type="time" id="templateStartTime" name="start_time">
                </div>

                <div class="form-group">
                    <label for="templateEndTime">Время окончания</label>
                    <input type="time" id="templateEndTime" name="end_time">
                </div>
            </div>

            <div class="form-group">
                <label for="templateRoom">Кабинет</label>
                <input type="text" id="templateRoom" name="room" placeholder="Например: 301">
            </div>

            <div class="modal-buttons">
                <button type="submit" class="btn btn-primary">Сохранить</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Отмена</button>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно для добавления нового предмета -->
<div id="newSubjectModal" class="modal">
    <div class="modal-content small-modal">
        <h2><img src="{{ url_for('static', path='assets/bx-plus-circle.svg') }}" class="invert"> Новый предмет</h2>
        <form id="newSubjectForm" onsubmit="createNewSubject(event)">
            <div class="form-group">
                <label for="newSubjectName">Название предмета *</label>
                <input type="text" id="newSubjectName" name="name" required
                       placeholder="Например: Алгебра, Физика, История"
                       maxlength="50">
            </div>

            <div class="form-group">
                <label for="newSubjectDescription">Описание (необязательно)</label>
                <textarea id="newSubjectDescription" name="description"
                          rows="3" placeholder="Краткое описание предмета"></textarea>
            </div>

            <div class="modal-buttons">
                <button type="submit" class="btn btn-primary">Создать предмет</button>
                <button type="button" class="btn btn-secondary" onclick="closeNewSubjectModal()">Отмена</button>
            </div>
        </form>
    </div>
</div>

<!-- Подтверждение удаления -->
<div id="confirmModal" class="modal">
    <div class="modal-content small-modal">
        <h2>⚠️ Подтверждение</h2>
        <p id="confirmMessage">Вы уверены, что хотите удалить этот урок?</p>
        <div class="modal-buttons">
            <button class="btn btn-danger" onclick="confirmDelete()">Удалить</button>
            <button class="btn btn-secondary" onclick="closeConfirmModal()">Отмена</button>
        </div>
    </div>
</div>

<script src="{{ url_for('static', path='js/add_lesson.js') }}"></script>
{% endblock %}
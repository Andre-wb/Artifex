{% extends "base.html" %}

{% block title %}–®–∞–±–ª–æ–Ω —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è{% endblock %}

{% block extra_css %}
<style>
  .templates-container {
    max-width: 800px;
    margin: 0 auto;
  }

  .day-section {
    background: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }

  .day-title {
    font-size: 1.3em;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #3498db;
  }

  .template-lesson {
    display: grid;
    grid-template-columns: 80px 1fr 100px 50px;
    gap: 10px;
    padding: 10px;
    border-bottom: 1px solid #f0f0f0;
    align-items: center;
  }

  .template-lesson:hover {
    background: #f8f9fa;
  }

  .lesson-number {
    font-weight: bold;
    color: #3498db;
  }

  .lesson-subject {
    font-weight: 600;
  }

  .lesson-time {
    color: #7f8c8d;
    font-size: 0.9em;
  }

  .lesson-actions button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2em;
    padding: 5px;
  }

  .add-lesson-btn {
    background: none;
    border: 2px dashed #27ae60;
    color: #27ae60;
    padding: 10px;
    width: 100%;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9em;
    margin-top: 10px;
  }

  .add-lesson-btn:hover {
    background: #27ae60;
    color: white;
  }

  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .modal-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    color: #2c3e50;
    font-weight: 500;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1em;
  }

  .modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
    flex: 1;
  }

  .btn-primary {
    background: #3498db;
    color: white;
  }

  .btn-secondary {
    background: #95a5a6;
    color: white;
  }

  .btn-danger {
    background: #e74c3c;
    color: white;
  }

  .generate-btn {
    background: #27ae60;
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.1em;
    margin: 20px 0;
    width: 100%;
  }

  .generate-btn:hover {
    background: #229954;
  }
</style>
{% endblock %}

{% block content %}
<h1>üìÖ –®–∞–±–ª–æ–Ω —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h1>

<div class="templates-container">
  <button class="generate-btn" onclick="generateLessons()">
    üîÑ –°–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫–∏ –Ω–∞ 2 –Ω–µ–¥–µ–ª–∏ –≤–ø–µ—Ä–µ–¥ –∏–∑ —à–∞–±–ª–æ–Ω–∞
  </button>

  {% for day_index in range(7) %}
  <div class="day-section" data-day="{{ day_index }}">
    <div class="day-title">{{ weekdays[day_index] }}</div>

    <div class="templates-list" id="templates-{{ day_index }}">
      {% for template in templates if template.day_of_week == day_index %}
      <div class="template-lesson" data-template-id="{{ template.id }}">
        <div class="lesson-number">{{ template.lesson_number }}.</div>
        <div class="lesson-subject">{{ template.subject.name }}</div>
        <div class="lesson-time">
          {% if template.start_time %}
          {{ template.start_time }}{% if template.end_time %} - {{ template.end_time }}{% endif %}
          {% else %}
          –í—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ
          {% endif %}
        </div>
        <div class="lesson-actions">
          <button onclick="editTemplate({{ template.id }})">‚úèÔ∏è</button>
          <button onclick="deleteTemplate({{ template.id }})">üóëÔ∏è</button>
        </div>
      </div>
      {% endfor %}
    </div>

    <button class="add-lesson-btn" onclick="showAddTemplateModal({{ day_index }})">
      + –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫ –≤ {{ weekdays[day_index]|lower }}
    </button>
  </div>
  {% endfor %}
</div>

<div id="templateModal" class="modal">
  <div class="modal-content">
    <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫ –≤ —à–∞–±–ª–æ–Ω</h2>
    <form id="templateForm">
      <input type="hidden" id="templateId" name="templateId">
      <input type="hidden" id="templateDay" name="day_of_week">

      <div class="form-group">
        <label for="templateSubject">–ü—Ä–µ–¥–º–µ—Ç *</label>
        <select id="templateSubject" name="subject_id" required>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
          {% for subject in subjects %}
          <option value="{{ subject.id }}">{{ subject.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="templateLessonNumber">–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞ *</label>
        <input type="number" id="templateLessonNumber" name="lesson_number" min="1" max="8" required>
      </div>

      <div class="form-group">
        <label for="templateStartTime">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>
        <input type="time" id="templateStartTime" name="start_time">
      </div>

      <div class="form-group">
        <label for="templateEndTime">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
        <input type="time" id="templateEndTime" name="end_time">
      </div>

      <div class="form-group">
        <label for="templateRoom">–ö–∞–±–∏–Ω–µ—Ç</label>
        <input type="text" id="templateRoom" name="room">
      </div>

      <div class="modal-buttons">
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div>

<script>
  let currentEditTemplateId = null;

  function showAddTemplateModal(day) {
    document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫ –≤ —à–∞–±–ª–æ–Ω';
    document.getElementById('templateId').value = '';
    document.getElementById('templateDay').value = day;
    document.getElementById('templateForm').reset();
    document.getElementById('templateModal').style.display = 'flex';
  }

  function editTemplate(templateId) {
    fetch(`/diary/api/timetable-template/${templateId}`)
            .then(response => response.json())
            .then(template => {
              document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–∫ –≤ —à–∞–±–ª–æ–Ω–µ';
              document.getElementById('templateId').value = template.id;
              document.getElementById('templateDay').value = template.day_of_week;
              document.getElementById('templateSubject').value = template.subject_id;
              document.getElementById('templateLessonNumber').value = template.lesson_number;
              document.getElementById('templateStartTime').value = template.start_time || '';
              document.getElementById('templateEndTime').value = template.end_time || '';
              document.getElementById('templateRoom').value = template.room || '';
              document.getElementById('templateModal').style.display = 'flex';
            });
  }

  function closeModal() {
    document.getElementById('templateModal').style.display = 'none';
  }

  document.getElementById('templateForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const templateId = document.getElementById('templateId').value;
    const formData = {
      day_of_week: parseInt(document.getElementById('templateDay').value),
      lesson_number: parseInt(document.getElementById('templateLessonNumber').value),
      subject_id: parseInt(document.getElementById('templateSubject').value),
      start_time: document.getElementById('templateStartTime').value || null,
      end_time: document.getElementById('templateEndTime').value || null,
      room: document.getElementById('templateRoom').value || null
    };

    const url = templateId ? `/diary/api/timetable-template/${templateId}` : '/diary/api/timetable-template';
    const method = templateId ? 'PUT' : 'POST';

    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(formData)
    })
            .then(response => {
              if (response.ok) {
                closeModal();
                location.reload();
              } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
              }
            });
  });

  function deleteTemplate(templateId) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —É—Ä–æ–∫ –∏–∑ —à–∞–±–ª–æ–Ω–∞?')) {
      fetch(`/diary/api/timetable-template/${templateId}`, {
        method: 'DELETE'
      })
              .then(response => {
                if (response.ok) {
                  location.reload();
                } else {
                  alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
                }
              });
    }
  }

  function generateLessons() {
    if (confirm('–°–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫–∏ –Ω–∞ 2 –Ω–µ–¥–µ–ª–∏ –≤–ø–µ—Ä–µ–¥ –∏–∑ —à–∞–±–ª–æ–Ω–∞?')) {
      fetch('/diary/api/generate-lessons', {
        method: 'POST'
      })
              .then(response => response.json())
              .then(data => {
                alert(data.message);
                window.location.href = '/diary';
              });
    }
  }
</script>
{% endblock %}